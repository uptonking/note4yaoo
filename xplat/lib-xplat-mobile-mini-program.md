---
title: lib-xplat-mobile-mini-program
tags: [dev, mini-program, mobile]
created: 2021-04-21T17:01:43.679Z
modified: 2021-05-13T03:11:31.620Z
---

# lib-xplat-mobile-mini-program

# guide

# architecture

## [微信小程序的双线程模型](https://developers.weixin.qq.com/ebook?action=get_post_info&token=935589521&volumn=1&lang=zh_CN&book=miniprogram&docid=0006a2289c8bb0bb0086ee8c056c0a)

- 小程序是基于双线程模型的，在这个模型中，小程序的逻辑层与渲染层分开在不同的线程运行，这跟传统的Web单线程模型有很大的不同，使得小程序架构上多了一些复杂度，也多了一些限制。

### 技术选型

- 我们在对小程序的架构设计时的要求只有一个，就是要快，包括要渲染快、加载快等。
  - 当用户点开某个小程序时，我们期望体验到的是只有很短暂的加载界面，在一个过渡动画之后可以马上看到小程序的主界面。
- 一般来说，渲染界面的技术有三种：
  - 用纯客户端原生技术来渲染
  - 用纯Web技术来渲染
  - 介于客户端原生技术与Web技术之间的，互相结合各自特点的技术（下面统称 Hybrid 技术）来渲染
- 由于**小程序的宿主是微信，所以我们不太可能用纯客户端原生技术来编写小程序**。
  - 如果这么做，那小程序代码需要与微信代码一起编包，跟随微信发版本，这种方式跟开发节奏必然都是不对的。
  - 因此，我们需要像Web技术那样，有一份随时可更新的资源包放在云端，通过下载到本地，动态执行后即可渲染出界面。
- 但是，如果我们用纯Web技术来渲染小程序，在一些有复杂交互的页面上可能会面临一些性能问题，
  - 这是因为在Web技术中，UI渲染跟 JavaScript 的脚本执行都在一个单线程中执行，这就容易导致一些逻辑任务抢占UI渲染的资源。
- 使用纯客户端原生技术或纯Web技术都有各自的缺点，那如果使用两者结合起来的 Hybrid 技术来渲染小程序，能否优于各自独立渲染的技术方案呢？
  - 实际上，这种 Hybrid 技术在业界过去几年里演化过数种技术方案，典型的如早期的PhoneGap，还有近两年流行的React Native（下称 RN），还有像微信网页里的 JS-SDK这种轻量级的应用。
- 从渲染底层来看，PhoneGap与微信 JS-SDK 是类似的，它们最终都还是使用浏览器内核来渲染界面。
- 而RN则不同，虽然是用Web相关技术来编写，同样是利用了 JavaScript 解释执行的特性，但RN在渲染底层是用客户端原生渲染的。
  - 实际上，小程序最初选型时RN是候选之一，虽然说RN是结合了React框架的代码组成方式，但是我们完全可以剥离React框架这套写法，定义出更符合小程序特点的代码组成方式。
- 不过，**最终我们并没有选择这种类RN技术**，原因有三：
  - RN所支持的样式是CSS的子集，会满足不了 Web 开发者日渐增长的需求，而对RN的改造具有不小的成本和风险。
  - RN现有能力下还存在的一些不稳定问题，比如性能、Bug等。**RN是把渲染工作全都交由客户端原生渲染**，实际上一些简单的界面元素使用Web技术渲染完全能胜任，并且非常稳定。
  - RN存在一些不可预期的因素，比如近期就出现了许可协议问题。
- **最终，我们选择类似于微信JS-SDK这样的 Hybrid 技术**，
  - 即界面主要由成熟的Web技术渲染，辅之以大量的接口提供丰富的客户端原生能力。
  - 同时，**每个小程序页面都是用不同的WebView去渲染**，这样可以提供更好的交互体验，更贴近原生体验，也避免了单个WebView的任务过于繁重。
  - 此外，界面渲染这一块我们定义了一套内置组件以统一体验，并且提供一些基础和通用的能力，进一步降低开发者的学习门槛。
  - 值得一提的是，内置组件有一部分较复杂组件是用客户端原生渲染的，以提供更好的性能，在后面的章节中将深入介绍。

### 安全控制

- 基于Web技术来渲染小程序是存在一些不可控因素和安全风险的。
  - 这是因为Web技术是非常开放灵活的，我们可以利用JavaScript脚本随意地跳转网页或者改变界面上的任意内容。
- 我们原本定义了一套内置组件以提供统一的体验，用户进入小程序时，小程序代码包会被拉到本地（第七章将会详细介绍），这使得小程序可以离线浏览（只要小程序开发者把一些应用数据缓存到了本地），
  - 但要是开发者通过JavaScript把渲染小程序的 WebView 跳转到其他在线网页，这个体验就变得非常糟。
- 除此之外，我们也提供一种可以展示敏感数据的组件（这些数据只能被展示，开发者并不能拿到数据），若开发者可以通过JavaScript 操作界面（DOM树），从而直接获取这些敏感数据，那小程序毫无安全可言。
- 为了解决管控与安全问题，我们必须阻止开发者使用一些浏览器提供的，诸如跳转页面、操作DOM、动态执行脚本的开放性接口。
  - 假设我们一个一个禁止，那势必会进入一个攻防战，这是因为 JavaScript的灵活性以及浏览器接口的丰富性，我们很容易遗漏一些危险的接口，而且就算被我们找到所有危险的接口，也许在下一次浏览器内核更新而新增了一个可能会在这套体系下产生漏洞的接口，这样还是无法完全避免。
- 因此，要彻底解决这个问题，我们必须提供一个沙箱环境来运行开发者的JavaScript代码。
  - **这个沙箱环境不能有任何浏览器相关接口，只提供纯JavaScript的解释执行环境，那么像HTML5中的ServiceWorker、WebWorker特性就符合这样的条件**，这两者都是启用另一线程来执行JavaScript。
  - 但是考虑到小程序是一个多WebView的架构，每一个小程序页面都是不同的WebView渲染后显示的，在这个架构下我们不好去用某个WebView中的ServiceWorker去管理所有的小程序页面。
- 得益于客户端系统有JavaScript的解释引擎（在iOS下是用内置的 JavaScriptCore框架，在安卓则是用腾讯x5内核提供的JsCore环境），
  - 我们可以创建一个单独的线程去执行JavaScript，在这个环境下执行的都是有关小程序业务逻辑的代码，也就是我们前面一直提到的逻辑层。
  - 而界面渲染相关的任务全都在WebView线程里执行，通过逻辑层代码去控制渲染哪些界面，那么这一层当然就是所谓的渲染层。
  - 这就是小程序双线程模型的由来。

### 内在延时

- 既然小程序是基于双线程模型，那就意味着任何数据传递都是线程间的通信，也就是都会有一定的延时。
  - 这不像传统Web那样，当界面需要更新时，通过调用更新接口UI就会同步地渲染出来。在小程序架构里，这一切都会变成异步。
- 异步会使得各部分的运行时序变得复杂一些。
  - 比如在渲染首屏的时候，逻辑层与渲染层会同时开始初始化工作，但是渲染层需要有逻辑层的数据才能把界面渲染出来，如果渲染层初始化工作较快完成，就要等逻辑层的指令才能进行下一步工作。
  - 因此逻辑层与渲染层需要有一定的机制保证时序正确，这些工作在小程序框架里会处理好，开发者只需要理解生命周期，以及控制合适的时机更新UI即可。
- **除了逻辑层与渲染层之间的通信有延时，各层与客户端原生交互同样是有延时的**。
  - 以逻辑层为例，开发者的代码是跑在逻辑层这个线程之上，而客户端原生是跑在微信主线程（安卓上是线程）之上，所以注册给逻辑层有关客户端能力的接口，实际上也是跟微信主线程之间的通信，同样意味着有延时。
  - 这也是我们看到大部分提供的接口都是异步的原因。
- 在理解了小程序架构下很多天生的延时后，我们会更容易想到一些问题的解决方法。
  - 比如，我们在使用一块画布（canvas组件）做图像处理并导出照片时，会习惯地在调用draw方法渲染后，立即调用 wx.canvasToTempFilePath 接口来导出图片，实际上很有可能调用的时刻画布还未完成渲染而使导出的图片不是期望的效果。

## 组件系统

- 小程序的视图是在WebView里渲染的，那搭建视图的方式自然就需要用到HTML语言。
  - 如果我们直接提供HTML的能力，那前面章节所介绍的为解决管控与安全而建立的双线程模型就成为摆设了。
  - 开发者可以利用A标签实现跳转到其它在线网页，也可以动态执行JavaScript等。
- 除管控与安全外，还有一些的不足之处：
  - 标签众多，增加理解成本；
  - 接口底层，不利于快速开发；
  - 能力有限，会限制小程序的表现形式。
- 因此，我们设计一套组件框架——Exparser。
  - 基于这个框架，内置了一套组件，以涵盖小程序的基础功能，便于开发者快速搭建出任何界面。
  - 同时也提供了自定义组件的能力，开发者可以自行扩展更多的组件，以实现代码复用。
- Exparser是微信小程序的组件组织框架，内置在小程序基础库中，为小程序的各种组件提供基础的支持。
  - 小程序内的所有组件，包括内置组件和自定义组件，都由Exparser组织管理。
- Exparser的组件模型与WebComponents标准中的ShadowDOM高度相似。
  - Exparser会维护整个页面的节点树相关信息，包括节点的属性、事件绑定等，**相当于一个简化版的Shadow DOM实现**。
- Exparser的主要特点包括以下几点：
  - 基于Shadow DOM模型：模型上与WebComponents的ShadowDOM高度相似，但不依赖浏览器的原生支持，也没有其他依赖库；实现时，还针对性地增加了其他API以支持小程序组件编程。
  - 可在纯JS环境中运行：这意味着逻辑层也具有一定的组件树组织能力。
  - 高效轻量：性能表现好，在组件实例极多的环境下表现尤其优异，同时代码尺寸也较小。
- 小程序中，所有节点树相关的操作都依赖于Exparser，包括WXML到页面最终节点树的构建、createSelectorQuery调用和自定义组件特性等。

- 在使用自定义组件的小程序页面中，Exparser将接管所有的自定义组件注册与实例化。
# discuss
- ## 

- ## 

- ## 

- ## [2022年了，uniapp发展的怎么样了?](https://www.zhihu.com/question/444976489/answer/1978635281)
- 优点是：
- 1、多端同步，降低开发成本

- 缺点是：
- 1、广告联盟被他们掐的死死的，不允许自己接入联盟，容易卸磨杀驴。小公司用用还行，等收入高了就算了。毕竟广告收入高了之后，搞一下你，随随便便就把开发成本丢出去了
- 2、官方比较自负，编辑器难用也就罢了，开发者也不太计较，官方说比vscode好用。

- 我觉得吧，虽说uni能一次开发那么多平台，但是如果公司或者个人处于初创阶段，自然也不需要那么多平台，react native或flutter 加微信小程序足以。如果业务足够大，那自然也不缺开发人员，大家可以专注自己的平台做的更好，甚至搞出自己公司的一套框架。
  - 我发现一种情况，就是那种帮其它公司开发app或者小程序的公司，或者给其它公司兼职的程序员，他们为了节约成本，用一种模板，一种技术，来应付各种需求，我觉得这大概是uni最大的市场。

- ## [小程序的机制（支付宝&微信的区别）](https://zhuanlan.zhihu.com/p/403869900)
- 在不同环境下的javascript脚本运行环境是不同的，微信小程序运行在三端：iOS（iPhone/iPad）、Android 和 用于调试的开发者工具。
- 在iOS上，
  - 小程序逻辑层的 javascript 代码运行在 JavaScriptCore 中，
  - 视图层是由 WKWebView 来渲染的，环境有iOS8、iOS9、iOS10；
- 在 Android 上，
  - 旧版本，小程序逻辑层的 javascript 代码运行中 X5 JSCore 中，视图层是由 X5 基于 MobileChrome 57 内核来渲染的
  - 新版本，小程序逻辑层的 javascript 代码运行在 V8 中，视图层是由自研 XWeb 引擎基于 Mobile Chrome 67 内核来渲染的；
- 在开发工具上，小程序逻辑层的 javascript 代码是运行在 NW.js 中，视图层是由 Chromium 60 Webview 来渲染的。

- ## [微信小程序和网页版程序的区别在哪里？](https://www.zhihu.com/question/54148303/answers/updated)
- 10M的缓存空间，稍微复杂点的应用要很多trick才能做出来。

- 互联网的信息流动不再自由了。
  - 是什么造成的这一点？两个东西的出现，社交网络和 App，
  - 他们的特点都是一样的：把自己封锁起来，让信息只进不出。
  - 互联网挨了这两刀，信息就都被困在小盒子里面了，不登录不能看，不关注不能看，不回复不能看，不用 App 不能看，不交费不能看…
  - 所谓的分享功能，好多只不过是吸引用户下载或注册的幌子…
  - 这时候我们再看看古老的「超级链接」，它可以说是互联网自由的大门，但是它在渐渐的关闭着。
- 能阻止么？
  - 很难。让信息只进不出，是互联网公司们一直想做的事情，在PC时代，大家虽然互有防备，但多少都基于同一个自由的协议，相互之间也就是一个标签页的距离。
  - 而移动时代，大家把信息交换的标准都私有化了，开始可能是网页的效率问题只能用App，但之后就是军备竞赛了。
  - 看一看有多少App几乎就是一个 Webview 就知道了，这和网页唯一的区别是能推送、抢入口、垄断信息。
  - 从商业上看，这是死循环，从互联网的本质上看，这让人难过。

- ## [如何评价微信小程序内嵌网页功能开放？](https://www.zhihu.com/question/67564075/answers/updated)
- 事实证明，类互联网生态不拥抱开放和标准是不行的，微信坚持小程序那么久不断的给其红利憋大招，最后发现还是憋不住了。
