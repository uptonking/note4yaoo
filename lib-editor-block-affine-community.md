---
title: lib-editor-block-affine-community
tags: [affine, block-editor, collaboration, community]
created: 2023-02-03T16:06:45.939Z
modified: 2023-02-03T16:12:13.346Z
---

# lib-editor-block-affine-community

# guide

# discuss
- ## 

- ## 

- ## 

- ## è¿™ç¡®å®æ˜¯ç›®å‰ BlockSuite æœ€å¤§çš„å›°æ‰°ä¹‹ä¸€, è·¨ block æ“ä½œ
- https://twitter.com/ewind1994/status/1743439055411708058
  - æœ€åˆï¼Œæˆ‘å°† BlockSuite è®¾è®¡ä¸ºåœ¨æ¯ä¸ª block é‡ŒåµŒå…¥ç‹¬ç«‹çš„å¯Œæ–‡æœ¬ç»„ä»¶ï¼ˆå³ç‹¬ç«‹çš„ contenteditableï¼‰ã€‚è¿™æ ·å†å¤æ‚çš„å¤æ‚ block åµŒå¥—ç»“æ„éƒ½èƒ½ç®€å•åœ°ç”¨æ ‡å‡†çš„å‰ç«¯æ¡†æ¶æ¸²æŸ“å‡ºæ¥ï¼Œåªæ˜¯å…¶ä¸­çš„å¯Œæ–‡æœ¬éƒ¨åˆ†èµ°ç‹¬ç«‹çš„ inline editor è€Œå·²ã€‚è¿™ç§ inline editor ä¹Ÿç‰¹åˆ«ç®€å•ï¼Œ @flrande åˆšæ¥å®ä¹ å‡ å‘¨å°±æå®šäº†
  - è¿™æ ·å¼€å‘æ•ˆç‡éå¸¸é«˜ï¼Œä½†å°±ä¼šé‡åˆ°æ¨ªè·¨å¤šä¸ª block æ—¶åŸç”Ÿé€‰åŒºçš„é—®é¢˜ã€‚ğŸ› BlockSuite æ²¿ç”¨è‡³ä»Šçš„æ–¹å¼æ˜¯æ‰‹åŠ¨åŸºäºæ‹–æ‹½èµ·æ­¢ä½ç½®ç®—é€‰åŒºï¼Œè¿™æ ·é—®é¢˜å¾ˆå¤šï¼Œå…¶ä»–ç¼–è¾‘å™¨éƒ½æ²¡æœ‰è¿™ä¹ˆåšã€‚ä½†æˆ‘ä¸€æ®µæ—¶é—´å†…éƒ½è®¤ä¸ºè¿™å±äºæ¡†æ¶çš„å·®å¼‚åŒ–äº®ç‚¹ï¼Œç°åœ¨çœ‹æ¥è¿™æ˜¯ä¸ªè¯¯åŒºã€‚
  - ä½†æ¼”åŒ–ä¸­æˆ‘ä»¬é€æ¸å‘ç°ï¼ŒBlockSuite çœŸæ­£çš„äº®ç‚¹å¹¶ä¸æ˜¯èµ°å•ä¸ª contenteditable è¿˜æ˜¯å¤šä¸ªè¿™ç§å±‚é¢çš„å®ç°ç»†èŠ‚ï¼Œè€Œæ˜¯ã€Œèƒ½è¿™ä¹ˆåšã€èƒŒåçš„æœ¬æºï¼šè¿™ç§æ¨¡å¼ä½¿å¾—æ‰€æœ‰å­ editor çš„çŠ¶æ€éƒ½å…¨æƒç”±ä¸€ä»½ä¸­å¿ƒåŒ–çš„ CRDT æ–‡æ¡£ç®¡ç†ã€‚æ¢è¨€ä¹‹ï¼Œä»¥å‰åšç¼–è¾‘å™¨æ—¶å›´ç»• editor è®¾è®¡çŠ¶æ€ä¸æ•°æ®ç”Ÿå‘½å‘¨æœŸçš„æ¶æ„è¢«æ¨ç¿»äº†ã€‚
  - è¿™ä½¿å¾— BlockSuite å…è®¸ä½ æŠŠä¼ ç»Ÿä¸Šçš„ä¸€ä¸ªå¤§å•ä½“ editor éšä¾¿åˆ‡åˆ†æ‰ï¼Œåªè¦å„ä¸ªç»„ä»¶éƒ½è¿åˆ°åŒä¸€ä»½ CRDT æ•°æ®å±‚ä¸Šå°±èƒ½å³æ’å³ç”¨ã€‚ä¸ºæ­¤æˆ‘ä»¬è¿›ä¸€æ­¥æ”¯æŒäº†ä¸€ç§å« fragment çš„ç»„ä»¶ï¼Œè¿™ç§ç»„ä»¶èƒ½åœ¨ editor å¤–é¢ç‹¬ç«‹å­˜åœ¨ã€‚
  - ç°åœ¨çœ‹æ¥ï¼Œå•ä¸ªè¿˜æ˜¯å¤šä¸ª contenteditable å…¶å®å¹¶ä¸é‚£ä¹ˆé‡è¦ï¼Œå­¦å…¶ä»–ç¼–è¾‘å™¨æ¢å›å»ä¹Ÿé—®é¢˜ä¸å¤§ã€‚ä¸”è¿™ä¹Ÿåªæ˜¯ä¸€ä¸ªå±€éƒ¨æ”¹é€ ï¼Œå·²ç»è®¾è®¡å¥½çš„ API éƒ½èƒ½ç»§ç»­æ²¿ç”¨ã€‚

- ## ä¼ ç»Ÿä¸ŠåŸºäºæ–‡ä»¶çš„æ–‡æ¡£åŒæ­¥ç²’åº¦å¾ˆç²—ï¼Œå®¹æ˜“äº§ç”Ÿå†²çªã€‚AFFiNE åˆ™æ˜¯å°†ä¸€ç¯‡æ–‡æ¡£çš„ block tree ç¼–ç åˆ°ç±»ä¼¼ protobuf çš„ CRDT binary æ ¼å¼ï¼Œåœ¨å¤šäººåä½œæ—¶åˆ†å‘å„è‡ªçš„ patch æ¥é©±åŠ¨çŠ¶æ€æ›´æ–°ã€‚
- https://twitter.com/ewind1994/status/1717050757546168667
  - ä½ å¯ä»¥è®¤ä¸º AFFiNE çš„ workspace å°±æ˜¯ clone åˆ°ä½ æœ¬åœ°çš„ç‰¹æ®Šæ ¼å¼ git ä»“åº“ï¼Œè‡ªå¸¦å­—ç¬¦ç²’åº¦çš„å†²çªè§£å†³ã€‚
  - AFFiNE çš„è·¯çº¿ç›¸æ¯”ä½¿ç”¨ JSON æˆ– protobuf çš„ä¸åŒä¹‹å¤„åœ¨äºï¼Œä½œä¸ºæ–‡æ¡£çŠ¶æ€ source of truth çš„ CRDT binary æ”¯æŒåœ¨å„ä¸ªè®¾å¤‡ä¸Šä»¥ä»»æ„é¡ºåºäº’ç›¸åˆå¹¶ patchï¼ŒåŒæ—¶ä¿è¯æœ€ç»ˆä¸€è‡´æ€§ã€‚è¿™å¯ä»¥å»æ‰åœ¨å¤šäººåä½œæ—¶ä¼ ç»Ÿä¸Šå¯¹ä¸­å¤®èŠ‚ç‚¹çš„ä¾èµ–ï¼Œç”šè‡³å…è®¸ P2P çš„æ•°æ®åŒæ­¥ï¼ˆè¿˜æ²¡åšï¼Œå¥½å¤šæ›´ä¼˜å…ˆçš„äº‹æƒ…ï¼‰
  - ä½† CRDT è™½ç„¶å¯¹ local first åº”ç”¨è‡³å…³é‡è¦ï¼Œå®ƒå’Œ cloud app å¹¶ä¸å†²çªã€‚ä¸€ä¸ªæƒ³æ”¯æŒå¤šäººåä½œçš„ SaaS äº§å“å®Œå…¨å¯ä»¥å°† CRDT ä½œä¸ºæˆ¿é—´ä¸­åŒæ­¥æ•°æ®çš„ä¼ è¾“å±‚æ¥ä½¿ç”¨ï¼Œè¿™ä¹Ÿæ˜¯ AFFiNE åœ¨è‡ªå·±çš„ cloud æœåŠ¡ä¸­æ‰€ä½¿ç”¨çš„æ¨¡å¼ã€‚æ‰€ä»¥åŸºäº CRDT çš„åä½œæŠ€æœ¯æ ˆå…¶å®è¿˜æ˜¯ç›¸å½“ progressive çš„ã€‚
- ä¸ºä»€ä¹ˆè¿™ä¸ªåè®®ä¸èƒ½æ˜¯git
  - åŸºäº git æ¥åš local first åº”ç”¨å½“ç„¶å¯è¡Œï¼Œåªæ˜¯è¿™æ—¶çš„äº§å“å¾€å¾€ä¼šæ›´é€‚åˆï¼ˆæˆ–è€…è¯´å—é™åœ¨ï¼‰å•äººçš„æ•°æ®åŒæ­¥ï¼Œè€Œä¸æ˜¯å¤šäººå®æ—¶åä½œã€‚æ³¨æ„ git çš„å†²çªå¤„ç†ç²’åº¦æ˜¯å•ä¸ªæ–‡ä»¶ï¼Œè€Œ CRDT æ˜¯å•ä¸ªå­—ç¬¦ï¼ˆä¸”èƒ½è‡ªåŠ¨åˆå¹¶ï¼‰ï¼Œæ‰€ä»¥åŸºäº git å¤©ç„¶åœ°å°±è¦ç”¨æˆ·æ›´å¤šåœ°æ‰‹åŠ¨è§£å†³å†²çªï¼Œä¸é‚£ä¹ˆé€‚åˆåº”ç”¨åœ¨é‡è§†å®æ—¶åä½œçš„äº§å“ä¸­ã€‚

- ## why you switch from Slate to Quill
- https://community.affine.pro/c/questions-answers/i-found-out-you-switched-from-slate-to-quill-in
- The original AFFiNE pre-alpha (open-sourced 2022/08) was using Slate as its editor framework. 
  - At that moment, we have already designed our architecture in a block-based way - this means that for a page with 100 blocks, we will hold 100 Slate instances, instead of a single monolith one, to render them. This allows us to use regular React components to compose our block tree, which greatly simplifies the block implementation of AFFiNE.
- However, there are several major cons with this approach:
  1. The selection and cursor states were managed by Slate autonomously, making it hard to reconcile the cursor after you edited multiple blocks and performed undo.
  2. The state synchronization between Slate and Yjs was too coarse grained. Every single edit within a text block will reset the block-level content, which bloats the history size and can't support character-wise collaboration.
  3. The code pattern was abusing hooks and didn't align to the best practice in React.

- So when I created BlockSuite, our own framework, I chose to leverage the block-based pattern with a more predictable tech stack. A major design decision here was to replace the rich text model with multiple Y. Text instances, so that we can support character-level time traveling.

- ## I would say that BlockSuite works very differently from traditional rich text editors_202301
- https://discord.com/channels/959027316334407691/1006208074316521573/1062287261724577822
- For rich text editing, multiple different nodes in the BlockSuite block tree can be connected to different rich text editing components, thus we are modeling rich text content as multiple UI components instead of a single UI container, eliminating the use of the dangerous monolith contenteditale - So for a page with hundreds of paragraphs, we can have hundreds of quill instances!
- With this design, the rich text components in BlockSuite will only contain **flat text content**, this greatly simplifies the architecture of managing rich text. 
  - That's also pretty much why we are using Quill temporally -  because its data structure is exactly modeled in this flat way, and its Delta format is natively supported by Yjs, bringing us a pretty stable experience. 
  - Based on this approach, we are actually only using a tiny feature subset of Quill, and it's also in our plan to build an alternative from the ground up.
- The thing that fascinates me about jumping out of the monolith contenteditable is to blur the boundary between the â€œeditorâ€ and â€œnon-editorâ€ part, making the tech stack of your collaborative app as regular as TodoMVC. 
- Note that this pattern requires a breakthrough in state management - for having intuitive undo/redo, we need to reconcile the state between different rich text components. Beforehand, I didnâ€™t see any store library that supports rich text as its primitive, and thatâ€™s why we built our general-purpose store on top of Yjs since thisâ€™s what CRDT is extremely good at. Think about Redux-like time traveling that comes with zero-cost, character-wise incremental updates!
- With such a store, the view components of your blocks only need to subscribe to model updates
- This is a standard best practice, and although we are using the Lit framework (mainly for future WebComponent-based extensibility prepared for AFFiNE), I believe there is no rocket science or black magic here, and thatâ€™s how we build our AFFiNE editor just like developing yet another Dashboard app. 
- We havenâ€™t started publicly endorsing this pattern because we are working hard on making the new AFFiNE stable and finding some best practices here. 

- This is also kind of how Notion is built if I'm not mistaken... It allows them to save each block as a row in the database as well, thus avoiding having to store a giant document with all the deltas generated by Yjs

- multiple-contentEditables design simplifies your initial implementation but prevents text selection of multiple blocks. Be careful accepting this limitation to begin with, because adding a wrapping ContentEditable later may be tricky.
