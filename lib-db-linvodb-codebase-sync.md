---
title: lib-db-linvodb-codebase-sync
tags: [codebase, linvodb, synchronization]
created: 2023-01-16T21:14:39.658Z
modified: 2023-01-16T21:14:55.049Z
---

# lib-db-linvodb-codebase-sync

# guide

# linvodbæ•°æ®åº“åŒæ­¥çš„æŠ€æœ¯æ–¹æ¡ˆ-v1
- åˆç‰ˆæ–¹æ¡ˆé‡‡ç”¨ä¸­å¿ƒæœåŠ¡å™¨çš„æ–¹å¼åŒæ­¥
- åŒæ­¥ä½¿ç”¨æ’ä»¶æ¶æ„ï¼Œåœ¨æ•°æ®åº“çš„crudä¸­æ³¨å…¥
  - å‚è€ƒidbsidesync
- è®¡ç®—ä¸¤è®¾å¤‡çš„æœ€å°å˜æ›´æ ‘æ¯”è¾ƒåå†³å®šé‡‡å–çš„æ–¹æ¡ˆæ˜¯æ•°æ®åº“æŸ¥è¯¢ï¼Œè€Œä¸ä½¿ç”¨merkle-trieæˆ–patricia-trieæ¥è®¡ç®—æœ€å°å˜æ›´èŠ‚ç‚¹ï¼Œ
  - å› ä¸ºç†è§£è¾ƒéš¾ï¼Œ
  - è€ƒè™‘åˆ°å½“ä¸€ä¸ªç”¨æˆ·æœ‰å¤šä¸ªè®¾å¤‡æ—¶ï¼Œæœ¬åœ°éœ€è¦ç»´æŠ¤å¤šé¢—æ ‘ï¼Œä¸å¦‚ç”¨æ•°æ®åº“ç›´è§‚
- åŒæ­¥åŠŸèƒ½ä»¥æ¥å£çº¦æŸï¼Œæ–¹ä¾¿æ‰©å±•
  - opæ•°æ®åŒæ­¥çš„æœåŠ¡ç«¯å®ç°ä¸ä¸€å®šè¦æ˜¯linvodbï¼Œæ”¯æŒsqlite
  - ä¸¤ä¸ªlinvodbç›¸äº’åŒæ­¥æ—¶ï¼Œæä¾›ä¾¿æ·å·¥å…·
- hlcçš„ä½¿ç”¨
  - tinybaseçš„hlcæ— ä¾èµ–ï¼Œæ–¹ä¾¿æµ‹è¯•
# hlc-sync
- éš¾ç‚¹
  - ä¸æ•°æ®è¡¨å…³è”çš„change-treeçš„æ„å»º
  - ä¸¤æ£µchange-treeçš„diffï¼Œç›®æ ‡æ˜¯è®¡ç®—å‡ºæœ€å°

- from æ•°æ®é›†D1  to æ•°æ®é›†D2 çš„åä½œæµç¨‹
  - åœ¨D1/D2æ—¥å¸¸çš„crudä¸­æ„å»º change-tree
  - è·å–D1çš„change-treeç›¸å¯¹äºD2çš„æœ€å°diff-tree
  - æ ¹æ®diff-treeæ›´æ–°D2

- ğŸ¤” ä»£ç ç–‘é—®ï¼Œåœ¨ä½¿ç”¨ä¸­å¿ƒæœåŠ¡å™¨çš„å‰æä¸‹
  - æ˜¯å¦æœ‰å¿…è¦æ¯æ¬¡å‘é€å®Œæ•´çš„change-tree?
    - è‹¥æ˜¯2é˜¶æ®µåŒæ­¥ï¼Œåˆ™æ— å¿…è¦
  - change-treeçš„ç»“æ„è®¾è®¡ `{ time1: { time2: {counter: {clientId:changeObj} } } }`, ä¸ºä½•å°†hlcåˆ†ä¸º4éƒ¨åˆ†ï¼Œä¸ºä½•ç”¨3+4è€Œä¸æ˜¯4+3/2+5
  - latestHlcsByCell ä¼¼ä¹æ— ç”¨ï¼Œå¯åˆ é™¤
  - TREE_DEPTH = 3 ä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡
# âœ¨ linvo-sync
- linvodbçš„æ€è·¯æ˜¯åœ¨DataModelçš„inserted/updatedé’©å­å‡½æ•°ä¸­æ‰§è¡Œ `triggerSync()`ï¼Œå³æ¯ä¸ªdmlæ“ä½œéƒ½æ‰§è¡Œ

- linvodbçš„åŒæ­¥é€»è¾‘åˆ†ä¸¤é˜¶æ®µï¼Œå…ˆæŸ¥è¯¢è¿œç¨‹å…ƒæ•°æ®

- æ¯æ¬¡ triggerSync çš„é€»è¾‘
  1. ensure_indexesï¼Œæ„å»ºæœ¬åœ°ç´¢å¼•
  2. retrieve_remote_metaï¼Œè¯·æ±‚è¿œç¨‹å˜æ›´å…ƒæ•°æ®ï¼Œ`{ id: datetime }` é›†åˆ
  3. compile_changesï¼Œéå†æœ¬åœ°idæ¯”è¾ƒå¹¶å¯¹åº”è¿œç¨‹å˜æ›´å…ƒæ•°æ®idæ¯”è¾ƒï¼Œå°†æ‰€æœ‰idsåˆ†ç±» toPull/toPush
  4. push_remoteï¼Œå°†æœ¬åœ°toPushæ•°æ®å‘é€åˆ°è¿œç¨‹
  5. pull_localï¼Œå°†è¿œç¨‹toPullæ•°æ®è¯·æ±‚åˆ°æœ¬åœ°ï¼Œç„¶åinsert/saveåˆ°æœ¬åœ°æ•°æ®åº“
  6. finalizeï¼Œå®Œæˆåemit syncEndäº‹ä»¶
- ä¾èµ–3ä¸ªæœåŠ¡ç«¯apiï¼ŒAPI.request 
  - datastoreMeta
  - datastorePut
  - datastoreGet
