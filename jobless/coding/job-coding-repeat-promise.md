---
title: job-coding-repeat-promise
tags: [async, coding, promise, repeat, ÊâãÊíï‰ª£Á†Å]
created: 2021-09-23T08:20:13.005Z
modified: 2021-10-06T17:17:34.809Z
---

# job-coding-repeat-promise

# ÂÆûÁé∞promiseÁöÑ‰∏Ä‰∏™Á§∫‰æã

- Promise.all
  - Âè™Ë¶ÅÂÖ∂‰∏≠‰ªª‰Ωï‰∏Ä‰∏™promise‰ªªÂä°Â§±Ë¥•‰∫ÜÔºåÂ∞±‰ºöÁõ¥Êé•ËøîÂõûËøô‰∏™Â§±Ë¥•ÁöÑÁªìÊûú„ÄÇÂÖ∂‰ªñÁöÑÂøΩÁï•„ÄÇ 
  - Âè™Êúâ‰ªªÂä°Êï∞ÁªÑ‰∏≠ÂÖ®ÈÉ®ÈÉΩÊàêÂäü‰∫ÜÔºåÊâç‰ºöÊääÊâÄÊúâÁöÑ‰ªªÂä°ÁªìÊûúÂÖ®ÈÉ®ËøîÂõû„ÄÇË∞ÉÁî® .then ‰∏≠ÁöÑÊàêÂäüÂõûË∞É
  - Promise.allËøîÂõûÁöÑÊòØpromiseÊâÄ‰ª•ÂèØ‰ª•ÁªßÁª≠Ë∞ÉÁî®promiseÂéüÂûã‰∏äÁöÑÊñπÊ≥ïÔºåÂè™ÊòØÊ≤°ÊúâÂÄºËÄåÂ∑≤
- ‰ΩøÁî®Âú∫ÊôØ
  - ÂΩºÊ≠§Áõ∏‰∫í‰æùËµñÔºåÂÖ∂‰∏≠‰ªª‰Ωï‰∏Ä‰∏™Ë¢´ reject ÔºåÂÖ∂ÂÆÉÈÉΩÂ§±Âéª‰∫ÜÂÆûÈôÖ‰ª∑ÂÄº

- Promise.allSettled
  - ÂèØ‰ª•Ëé∑ÂèñÊï∞ÁªÑ‰∏≠ÊØè‰∏™ promise ÁöÑÁªìÊûúÔºåÊó†ËÆ∫ÊàêÂäüÊàñÂ§±Ë¥•
- ‰ΩøÁî®Âú∫ÊôØ
  - ÊúüÊúõÁü•ÈÅìÊØè‰∏™ promise ÁöÑÊâßË°åÁªìÊûú
  - ÂΩºÊ≠§‰∏ç‰æùËµñÔºåÂÖ∂‰∏≠‰ªª‰Ωï‰∏Ä‰∏™Ë¢´ rejectÔºåÂØπÂÖ∂ÂÆÉÈÉΩÊ≤°ÊúâÂΩ±Âìç

```JS
/**
 * * üí°Ô∏è ÂÆûÁé∞promiseÁöÑ‰∏Ä‰∏™Á§∫‰æã
 * https://wangyaxing.cn/blog/jsCode/%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAPromise.html
 * * 3‰∏™ÂÆû‰æãÂ±ûÊÄßÔºöthis.status, this.resolveList, this.rejectList
 * * then()ÊñπÊ≥ïÁöÑ‰ΩúÁî®ÊòØÂ∞ÜÂõûË∞ÉÂáΩÊï∞Ê≥®ÂÜåÂà∞ this.resolveList/rejectList
 * * execResolve()/execReject()ÁöÑ‰ªªÂä°ÊòØÊîπÂèòÁä∂ÊÄÅÔºå‰ª•ÂèäÊâßË°åresolveListÁöÑÂáΩÊï∞ÔºåÂ∞Üvalue/reason‰º†ÈÄíÁªôÊ≥®ÂÜåËøáÁöÑcb
 *
 */
class Promise {
  constructor(executor) {
    /**
     *  ‰∏âÁßçÁä∂ÊÄÅÔºöpendingËøõË°å‰∏≠; fulfilledÂ∑≤ÊàêÂäü; rejected Â∑≤Â§±Ë¥•
     */
    this.status = 'pending';

    this.resolveList = []; // ÊàêÂäüÂêéÂõûË∞ÉÂáΩÊï∞
    this.rejectList = []; // Â§±Ë¥•ÂêéÁöÑÂõûË∞ÉÂáΩÊï∞
    this.finalList = [];

    executor(this.execResolve.bind(this), this.execReject.bind(this));
  }

  execResolve(value) {
    if (this.status !== 'pending') return;
    this.status = 'fulfilled';

    // Âª∂ËøüÊâßË°åÔºåÊèê‰æõÊú∫‰ºöËÆ©then()ÊñπÊ≥ïÊâßË°åÊ≥®ÂÜå‰∫ã‰ª∂Â§ÑÁêÜÂáΩÊï∞
    setTimeout(() => {
      this.resolveList.forEach((fn) => {
        value = fn(value);
      });
    });
  }

  execReject(reason) {
    if (this.status !== 'pending') return;
    this.status = 'rejected';

    setTimeout(() => {
      this.rejectList.forEach((fn) => {
        reason = fn(reason);
      });
    });
  }

  /** üí°Ô∏è ‰ªªÂä°ÊòØÊ≥®ÂÜåÊàêÂäüÊàñÂ§±Ë¥•ÂõûË∞ÉÂáΩÊï∞ */
  then(onResolve, onReject) {
    if (onResolve) {
      this.resolveList.push(onResolve);
    }
    if (onReject) {
      this.rejectList.push(onReject);
    }
    return this;
  }

  finally(onFinally) {
    // if (this.status === 'pending') return;

    if (onFinally && typeof onFinally === 'function') {
      this.finalList.push(onFinally);
    }

    return this;
  }

  /** Ê≥®ÂÜåÂºÇÂ∏∏Â§ÑÁêÜ */
  catch (cb) {
    if (cb) {
      this.rejectList.push(cb);
    }
    return this;
  }

  /**
   * ÂÆûÁé∞Promise.resolve
   * 1.ÂèÇÊï∞ÊòØ‰∏Ä‰∏™ Promise ÂÆû‰æã, ÈÇ£‰πàPromise.resolveÂ∞Ü‰∏çÂÅö‰ªª‰Ωï‰øÆÊîπ„ÄÅÂéüÂ∞Å‰∏çÂä®Âú∞ËøîÂõûËøô‰∏™ÂÆû‰æã„ÄÇ
   * 2.Â¶ÇÊûúÂèÇÊï∞ÊòØ‰∏Ä‰∏™ÂéüÂßãÂÄºÔºåÊàñËÄÖÊòØ‰∏Ä‰∏™‰∏çÂÖ∑ÊúâthenÊñπÊ≥ïÁöÑÂØπË±°ÔºåÂàôPromise.resolveÊñπÊ≥ïËøîÂõû‰∏Ä‰∏™Êñ∞ÁöÑ Promise ÂØπË±°ÔºåÁä∂ÊÄÅ‰∏∫resolved„ÄÇ
   */
  static resolve(data) {
    if (data instanceof Promise) {
      return data;
    }
    return new Promise((resolve, reject) => {
      resolve(data);
    });
  }

  // ÂÆûÁé∞Promise.reject
  static reject(err) {
    if (err instanceof Promise) {
      return err;
    }
    return new Promise((resolve, reject) => {
      reject(err);
    });
  }

  /**
   * ÂÆûÁé∞Promise.all
   * 1. Promise.allÊñπÊ≥ïÊé•Âèó‰∏Ä‰∏™Êï∞ÁªÑ‰Ωú‰∏∫ÂèÇÊï∞Ôºåp1„ÄÅp2„ÄÅp3ÈÉΩÊòØ Promise ÂÆû‰æãÔºåÂ¶ÇÊûú‰∏çÊòØÔºåÂ∞±‰ºöÂÖàË∞ÉÁî®‰∏ãÈù¢ËÆ≤Âà∞ÁöÑPromise.resolveÊñπÊ≥ïÔºåÂ∞ÜÂèÇÊï∞ËΩ¨‰∏∫ Promise ÂÆû‰æãÔºåÂÜçËøõ‰∏ÄÊ≠•Â§ÑÁêÜ„ÄÇ
   * 2. ËøîÂõûÂÄºÁªÑÊàê‰∏Ä‰∏™Êï∞ÁªÑ
   */
  static all(promises) {
    return new Promise((resolve, reject) => {
      let promiseCount = 0;
      const promisesLength = promises.length;
      const result = [];
      for (let i = 0; i < promises.length; i++) {
        // promises[i]ÂèØËÉΩ‰∏çÊòØPromiseÁ±ªÂûãÔºåÂèØËÉΩ‰∏çÂ≠òÂú®thenÊñπÊ≥ïÔºå‰∏≠Èó¥Â¶ÇÊûúÂá∫Èîô,Áõ¥Êé•ËøîÂõûÈîôËØØ
        Promise.resolve(promises[i]).then(
          (res) => {
            promiseCount++;
            // Ê≥®ÊÑèËøôÊòØËµãÂÄºÂ∫îËØ•Áî®‰∏ãÊ†áÂéªËµãÂÄºËÄå‰∏çÊòØÁî®pushÔºåÂõ†‰∏∫ÊØïÁ´üÊòØÂºÇÊ≠•ÁöÑÔºåÂì™‰∏™promiseÂÖàÂÆåÊàêËøò‰∏ç‰∏ÄÂÆö
            result[i] = res;
            if (promiseCount === promisesLength) {
              return resolve(result);
            }
          },
          (err) => {
            return reject(err);
          },
        );
      }
    });
  }

  static allSettled(promises) {
    return new Promise1((resolve, reject) => {
      const result = [];

      let count = 0;
      const len = promises.length;

      for (let i = 0; i < len; i++) {
        Promise1.resolve(promises[i])
          .then(
            (val) => {
              result[i] = { status: 'fulfilled', value: val };
            },
            (reason) => {
              result[i] = { status: 'rejected', reason };
            },
          )
          .finally(() => {
            count++;
            if (count === len) {
              resolve(result);
            }
          });
      }
    });
  }

  /**
   * ÂÆûÁé∞Promise.race
   * 1. Promise.raceÊñπÊ≥ïÁöÑÂèÇÊï∞‰∏éPromise.allÊñπÊ≥ï‰∏ÄÊ†∑ÔºåÂ¶ÇÊûú‰∏çÊòØPromiseÂÆû‰æãÔºåÂ∞±‰ºöÂÖàË∞ÉÁî®‰∏ãÈù¢ËÆ≤Âà∞ÁöÑPromise.resolveÊñπÊ≥ïÔºåÂ∞ÜÂèÇÊï∞ËΩ¨‰∏∫ Promise ÂÆû‰æãÔºåÂÜçËøõ‰∏ÄÊ≠•Â§ÑÁêÜ„ÄÇ
   * 2. ËøîÂõûÈÇ£‰∏™ÁéáÂÖàÊîπÂèòÁöÑ Promise ÂÆû‰æãÁöÑËøîÂõûÂÄº
   */
  static race(promises) {
    return new Promise((resolve, reject) => {
      for (let i = 0; i < promises.length; i++) {
        Promise.resolve(promises[i]).then(
          (res) => {
            return resolve(res);
          },
          (err) => {
            return reject(err);
          },
        );
      }
    });
  }
}

// ---- ÊµãËØïÁî®‰æã ----

const p = new Promise((resolve, reject) => {
  setTimeout(() => {
    console.log('resolve');
    resolve(222);
  }, 1000);
});

p.then((data) => {
    setTimeout(() => {
      console.log('data', data);
    });
    return 3333;
  })
  .then((data2) => {
    console.log('data2', data2);
  })
  .catch((err) => {
    console.error('err', err);
  });

const p1 = Promise.reject('Âá∫Èîô‰∫Ü');
p1.then(null, function(s) {
  console.log(s); // Âá∫Èîô‰∫Ü
});

const q1 = new Promise((resolve, reject) => {
  resolve('hello');
});

const q2 = new Promise((resolve, reject) => {
  resolve('world');
});
Promise.all([q1, q2]).then((res) => {
  console.log(res); // [ 'hello', 'world' ]
});
Promise.race([q1, q2]).then((res) => {
  console.log(res); // hello
});
```

# promiseÁöÑÂÆûÁé∞Á§∫‰æã2

```JS
/**
 * * promiseÊú¨Ë¥®‰∏äÂ∞±ÊòØ‰∏Ä‰∏™ÁªëÂÆö‰∫ÜÂõûË∞ÉÁöÑÂØπË±°
 * * Âú®promiseÂØπË±°ÂÜÖÈÉ®ÂÆö‰πâÊàêÂäüÂ§±Ë¥•ÁöÑÂõûË∞ÉÂáΩÊï∞ execResolve/execReject Ôºõ
 * * executorÁöÑËøîÂõûÂÄº‰ºöË¢´ÂøΩÁï•ÔºåÊú¨ÂáΩÊï∞ÂÜÖÈÉ®‰∏ÄËà¨ÂåÖÂê´ÂºÇÊ≠•Êìç‰ΩúÔºå‰∏çÂåÖÂê´‰πüÂèØ‰ª•
 * * ÂΩìÂºÇÊ≠•Êìç‰ΩúÁªìÊùüÊó∂ÔºåÁî±ÂºÄÂèëËÄÖÂ∞ÜÁªìÊûú‰º†Áªô execResolve(value)/execReject(reason)ÔºåÁÑ∂Âêé‰øùÂ≠òÂà∞this.value/reasonÔºåÂπ∂ÊâßË°åthenÊ≥®ÂÜåÁöÑÂõûË∞ÉÂáΩÊï∞
 * - state: pending, fulfilled, rejected, settled
 */
function Promise2(executor) {
  const _this = this;

  this.state = 'PENDING';
  this.value = undefined;
  this.reason = undefined;

  this.onFulfilled = [];
  this.onRejected = [];

  function execResolve(value) {
    if (_this.state === 'PENDING') {
      _this.state = 'FULFILLED';
      _this.value = value;
      _this.onFulfilled.forEach((fn) => fn(value));
    }
  }

  function execReject(reason) {
    if (_this.state === 'PENDING') {
      _this.state = 'REJECTED';
      _this.reason = reason;
      _this.onRejected.forEach((fn) => fn(reason));
    }
  }

  try {
    executor(execResolve, execReject);
  } catch (err) {
    reject(err);
  }
}

/**
 * * ÁÆÄÂçïÂÆûÁé∞ÁöÑÊîØÊåÅÂºÇÊ≠•ÁöÑthenÔºå‰∏ªË¶ÅÊòØÊ≥®ÂÜåÂõûË∞ÉÂáΩÊï∞Âà∞Âà∞promiseÂØπË±°„ÄÇ
 * - üëÄÔ∏è Êú™ËøîÂõûpromiseÂØπË±°Ôºå‰∏çÊîØÊåÅÈìæÂºèË∞ÉÁî®„ÄÇ
 */
Promise2.prototype.then2 = function(onResolved, onRejected) {
  if (this.state === 'FULFILLED') {
    typeof onResolved === 'function' && onResolved(this.value);
  }
  if (this.state === 'REJECTED') {
    typeof onRejected === 'function' && onRejected(this.reason);
  }

  if (this.state === 'PENDING') {
    typeof onResolved === 'function' && this.onFulfilled.push(onResolved);
    typeof onRejected === 'function' && this.onRejected.push(onRejected);
  }
};

const testPromise1 = new Promise2((resolve, reject) => {
  console.log(';;--start testPromise1');

  setTimeout(() => {
    // reject('reject-reason');
    resolve('success-value');
  }, 1500);
});

testPromise1.then2(
  (data) => {
    console.log('testPromise1- success', data);
  },
  (err) => {
    console.log('testPromise1- err', err);
  },
);
```

```JS
// promiseÊµãËØï
var original = Promise.resolve(33);
var cast = Promise.resolve(original);
original === cast // true
```

# ÊâãÂÜô async/await
- asyncÊòØgeneratorÂáΩÊï∞ÁöÑËØ≠Ê≥ïÁ≥ñ
  - ÂÜÖÁΩÆÊâßË°åÂô®
  - ËøîÂõûÂÄºÊòØPromiseÔºåËÄågeneratorËøîÂõûÁöÑÊòØËø≠‰ª£Âô®

- Ë∞ÉÁî® Generator ÂáΩÊï∞ÂêéÔºåËØ•ÂáΩÊï∞Âπ∂‰∏çÊâßË°åÔºå ËøîÂõûÁöÑ‰πü‰∏çÊòØÂáΩÊï∞ËøêË°åÁªìÊûúÔºå ËÄåÊòØ‰∏Ä‰∏™ÊåáÂêëÂÜÖÈÉ®Áä∂ÊÄÅÁöÑËø≠‰ª£Âô®ÂØπË±°
- ÊØèÊ¨°Ë∞ÉÁî® next ÊñπÊ≥ïÔºåÂÜÖÈÉ®ÊåáÈíàÂ∞±‰ªéÂáΩÊï∞Â§¥ÈÉ®Êàñ‰∏ä‰∏ÄÊ¨°ÂÅú‰∏ãÊù•ÁöÑÂú∞ÊñπÂºÄÂßãÊâßË°å Ôºå Áõ¥Âà∞ÈÅáÂà∞‰∏ã‰∏ÄÊù° yield ËØ≠Âè•ÔºàÊàñ return ËØ≠Âè•Ôºâ‰∏∫Ê≠¢ „ÄÇ
- yield ËØ≠Âè•Â∞±ÊòØÊöÇÂÅúÊ†áÂøó
  - ÈÅáÂà∞ yield ËØ≠Âè•Â∞±ÊöÇÂÅúÊâßË°åÂêéÈù¢ÁöÑÊìç‰Ωú Ôºå Âπ∂Â∞ÜÁ¥ßË∑üÂú® yield ÂêéÁöÑË°®ËææÂºèÁöÑÂÄº‰Ωú‰∏∫ËøîÂõû ÁöÑÂØπË±°ÁöÑ value Â±ûÊÄßÂÄº „ÄÇ
  - Generator ÂáΩÊï∞ÂèØ‰ª•‰∏çÁî® yield ËØ≠Âè•ÔºåËøôÊó∂Â∞±ÂèòÊàê‰∫Ü‰∏Ä‰∏™ÂçïÁ∫ØÁöÑÊöÇÁºìÊâßË°åÂáΩÊï∞ 

```JS
/**
 * * Êé•Âèó‰∏Ä‰∏™generatorÂáΩÊï∞ÔºåÁÑ∂ÂêéËá™Âä®ÊâßË°åËø≠‰ª£ÔºåÂú®Ëø≠‰ª£ÂÆåÊàêÂêéÔºåËøîÂõû...
 * https://segmentfault.com/a/1190000022705474
 */
function asyncToGenerator(genFn) {
  return function() {
    // Ë∞ÉÁî®generatorÂáΩÊï∞ ÁîüÊàêËø≠‰ª£Âô®
    const gen = genFn.apply(this, arguments);
    return new Promise((resolve, reject) => {
      /**
       * * Â∞ÅË£Ö‰∫ÜË∞ÉÁî®generatorÁöÑnext/throwÊñπÊ≥ïÁöÑËøáÁ®ã
       */
      function runIterator(fnName, args) {
        let genResult;
        try {
          genResult = gen[key](args);
        } catch (err) {
          return reject(err);
        }

        const { value, done } = genResult;

        if (done) {
          // Ëø≠‰ª£Âô®Ëø≠‰ª£ÂÆåÊàê‰∫ÜÔºåÊâç‰ºöresolve
          return resolve(value);
        } else {
          // Ëã•Êú™Ëø≠‰ª£ÂÆåÊàêÔºåÂ∞±ÁªßÁª≠Ë∞ÉÁî®nextÊñπÊ≥ï
          return Promise.resolve(value).then(
            (val) => runIterator('next', val),
            (err) => runIterator('throw', err),
          );
        }
      }

      /**
       * * Ëß¶ÂèëÊâßË°ågeneratorÂáΩÊï∞ËøîÂõûÂÄºÂØπË±°ÁöÑnext()ÊñπÊ≥ï
       */
      runIterator('next');
    });
  };
}

const getData = () => new Promise(resolve => setTimeout(() => resolve("data"), 1000))

var test = asyncToGenerator(
  function* testG() {
    // awaitË¢´ÁºñËØëÊàê‰∫Üyield
    const data = yield getData()
    console.log('data: ', data);
    const data2 = yield getData()
    console.log('data2: ', data2);
    return 'success'
  }
)

test().then(res => console.log(res))
```

# ÈôêÂà∂Âπ∂ÂèëËØ∑Ê±ÇÊï∞Èáè

```JS
class Scheduler {
  constructor() {
    this.queue = [];
    this.running = 0;
  }

  // ÊâßË°åÂÆå‰∏Ä‰∏™ÂêéÔºåËã•ÈòüÂàó‰∏≠ËøòÊúâÔºåÂ∞±ÁªßÁª≠ÊâßË°å
  run() {

    if (this.queue.length === 0 || this.running === 2) {
      return;
    }
    const p = this.queue.shift();
    this.running++;
    p().then((result) => {
      this.running--;

      // ÊâßË°åÂÆå‰∏Ä‰∏™ÂêéËøò‰ºöÁªßÁª≠ÊâßË°åÔºåÁõ¥Âà∞ÈòüÂàó‰∏∫Á©∫
      this.run();
      return result;
    })
  }

  add(promise) {
    this.queue.push(promise);
    this.run();
  }
}
const timout = (time) => new Promise(resolve => {
  setTimeout(resolve, time)
})
const scheduler = new Scheduler();

const addTask = (time, order) => {
  scheduler.add(() => timout(time).then(() => {
    console.log(order);
  }))
}

addTask(1000, '1');
addTask(500, '2');
addTask(300, '3');
addTask(400, '4');

// output: 2 3 1 4
// ‰∏ÄÂºÄÂßãÔºå1Ôºå 2‰∏§‰∏™‰ªªÂä°ËøõÂÖ•ÈòüÂàó
// 500msÊó∂Ôºå2ÂÆåÊàêÔºåËæìÂÖ•2Ôºõ‰ªªÂä°3ËøõÈòü
// 800msÊó∂Ôºå3ÂÆåÊàêÔºåËæìÂá∫ 3Ôºõ‰ªªÂä°4ËøõÈòü
// 1000msÊó∂Ôºå1ÂÆåÊàêÔºåËæìÂá∫1
// 1200msÊó∂Ôºå4ÂÆåÊàêÔºåËæìÂá∫4
```

```JS
/**
 * * promiseÈôêÂà∂Âπ∂ÂèëÊï∞Á§∫‰æã2
 * * ÊÄùË∑ØÔºöÂΩìcount>maxÊó∂ÔºåÁî®ÈòüÂàó‰øùÂ≠ò‰ªªÂä°ÂáΩÊï∞ÔºåÂê¶ÂàôÁ´ãÂç≥ÊâßË°å
 */
class PromiseScheduler {
  constructor(max) {
    this.max = max;
    this.count = 0;
    this.queue = [];
  }

  add(caller, ...args) {
    return new Promise((resolve, reject) => {
      const task = this.createTask(caller, args, resolve, reject);

      if (this.count >= this.max) {
        this.queue.push(task);
      } else {
        task();
      }
    });
  }

  createTask(caller, args, resolve, reject) {
    return () => {
      caller(...args)
        .then(resolve, reject)
        .finally(() => {
          this.count--;
          if (this.queue.length) {
            const task = this.queue.shift();
            task();
          }
        });
      // ÊâßË°å‰ªªÂä°ÂºÄÂßãÊó∂Ôºåcount+1ÔºåÊâßË°åÂÆåÊàêÊó∂Ôºåcount-1
      this.count++;
    };
  }
}

const timeout = (time) =>
  new Promise((resolve) => {
    setTimeout(resolve, time);
  });

const scheduler = new PromiseScheduler(2);

const addTask = (time, order) => {
  scheduler.add(() => timeout(time)).then(() => console.log(order));
};

// async function addTask(time, order) {
//   await scheduler.add(() => timeout(time));
//   console.log(order);
// }

addTask(1000, '1');
addTask(500, '2');
addTask(300, '3');
addTask(400, '4');
```
