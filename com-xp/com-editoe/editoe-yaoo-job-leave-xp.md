---
title: editoe-yaoo-job-leave-xp
tags: [editoe, job, yaoo]
created: 2022-07-21T04:18:52.546Z
modified: 2022-07-24T19:15:04.965Z
---

# editoe-yaoo-job-leave-xp

# editoe工作总结

- 第一份正式的工作在昨天告一段落，从2021-10-25到2022-07-20，上班后的日子过得飞快，关于代码的理解、关于工作的心态也变得越来越清晰。
# 技术方面
- 一开始加入公司的初心是做编辑器方面的开发，这一点公司提供了充足的条件。
- 在公司的工作历程大致可以分为早期编辑器EA开发、学术编辑器业务项目、块编辑器EB开发三个阶段。

## 早期编辑器EA

- 早期编辑器EA是直接下载了ckeditor的源码进行魔改和二次开发，导致后来上游官方ckeditor更新了功能和修复了bug，EA编辑器却不能直接合并更新和修复。小公司的研发能力是有限的，在手动同步上游更新的工作量变大后，又不得不重新迁回官方ckeditor，这就导致之前开发的插件基本都不可用了。这里的经验是在魔改复杂开源项目前，要衡量研发时间精力投入，否则事倍功半。
- 在开发和维护EA编辑器的阶段，对ckeditor的MVC架构有了比较深入的了解。model层通过schema定义了整个编辑器最核心的数据结构，view层分为editingView和dataView分别用来处理用户交互和导入导出，controller层会将view层的数据变更通过基于operation的converter应用到model数据层。
- 这一阶段我的工作重点是基于ckeditor的架构处理现有插件的bugs，比如菜单项失效、工具条不显示、流程图无法缩放等问题，工作比较零碎。
- 印象较为深刻的工作是，基于本地优先的架构处理图片上传和刷新页面恢复图片的问题。本地优先可以简单理解为将编辑器数据或用户数据暂时先保存在localStorage或indexeddb而不是服务端数据库，编辑器内图片url都是以`blob://`开头，每次刷新页面blob url都会失效，那应该什么时候将编辑器数据里面的图片url替换为有效的blob url呢？
  - 在加载数据时遍历xml字符串？ xml字符串遍历较慢，且会影响页面加载时间；加载多份数据时可能产生不必要的计算。
  - 在编辑器组件第一次加载后，在useEffect里面直接修改model数据？ 这种解决方案经常出bug，实践表明，其他插件的更新会导致useEffect提前执行，这里的经验是状态或数据不要过于依赖useEffect的执行时机。
  - 最终选择的方案是，在useEffect里面注册editor对象的`change:data`事件，在编辑器暴露的这个钩子函数里面更新指定图片elementTag的url属性，由编辑器对象控制替换url的时机。
- ckeditor的设计还有很多亮点，比如全局工具条的灵活配置，组件或元素的Widget蓝选区和工具条设计，command的灵活注册与执行。因为之前有prosemirror编辑器开发的基础，所以对编辑器架构的相似性理解更深刻了。
- ckeditor的优点是功能丰富，架构稳定，这也导致了它的定制成本很高，修改现有插件特别复杂。一个feature经常由4个以上的插件构成，并且这些插件还有依赖其他插件，所以排查问题很困难，链路很长，修改插件时不仅要修改当前插件包，还要修改依赖的其他插件包。

## 学术编辑器业务项目

- 在早期编辑器EA较为稳定后，开始了学术编辑器业务项目的开发与交付。
- 这一阶段我的工作重点是给现有编辑器开发学术相关插件，并负责了几乎整个产品的前端部分。工作内容包括编辑器双链与锚点、登录模块、网站布局、文档列表、学术参考文献bibtex列表、workspace的设计与配置、功能测试与修复。
- 这一阶段对react界面开发变得越来越熟练，常见的List、Card、Tab、TextInput组件的ui与交互变得越来越简单，并且对typescript的使用也更熟悉了。
- 印象较为深刻的工作是，编辑器数据auto save自动保存功能的实现和优化。
  - 编辑器对象提供了类似input的value和onChange方法，理论上只需要在onChange方法里面执行saveToDatabase()方法就可以了，但每次变动就触发数据库io很容易导致ui卡顿，节流是一个常用的优化方法，只用节流保存到数据库的逻辑，不用节流整个onChange方法。
  - 节流保存数据方法的简单实现类似 `const save = useCallback(throttle(() => saveToDatabase(data), 1000), [data])`，其中lodash的节流工具方法会无效，因为每次编辑器数据变化都会重新创建方法，这个bug花了一点时间才排查到。
  - 此外由于编辑器外部如保存图片等方法也会异步更新数据，对于先传图片再立即编辑的场景，编辑得到的新数据保存逻辑可能先执行，上传完图片异步更新数据再保存数据的逻辑可能后执行，这会导致旧数据覆盖新数据。
  - 最后是通过自己手动利用setTimeout和用stack结构保存数据且每次取栈顶的最新数据的方式，实现了自动保存最新数据的功能，这里的经验是不要过于依赖工具库，要理解原理，自己实现也不是很难。
- 在做具体业务项目开发的时候，更多的开发工作是完成客户需求，对react开发更熟悉了，但对于编辑器架构和插件的理解没有更深入。

## 块编辑器EB

- 由于技术债过重、主推产品变更等各种原因，三月底开始了新的项目 - 块编辑器EB。对于业内正在流行的块编辑器block editor，我的简单理解是在类似Word的普通富文本编辑器提供的基础功能上，增加块级拖拽、块级资源复用、块级协作编辑的能力。可参考的开源block editor并不多，且大多对于跨block在选区、操作方面的支持都一般，所以选择了只基于slate的文本格式能力来研发支持丰富block类型的block editor。
- 这一阶段我的工作重点是在block editor core提供的选区、光标、键盘、插件机制的基础上，增强block editor的能力，主要是编辑器的悬浮工具条和评论功能。
- 印象较为深刻的工作较多，因为自己对编辑器原理的理解不够全面和深入，对编辑器的选区操作、节点遍历api不够熟悉，所以实现具体功能的时候花费了大量时间。
- 碰到的比较难解决的问题是当编辑器上层出现悬浮工具条或弹窗时，如何保存和恢复编辑器的蓝色选区。
  - 当编辑器之上出现弹出层特别是输入框时，编辑器的selection选区对象默认会变为空，此时点击工具条的设置字体颜色或添加超链接按钮时，操作对应的编辑器里的文本节点因为selection变为空而获取不到。
  - 一种简单的解决思路是每次点击操作触发且编辑器selection变空前，先手动保存之前的selection对象到到缓存，然后执行操作逻辑，这种思路容易理解，但每个点击事件都有类似的重复逻辑，代码冗余。
  - 尝试寻找更好的解决方法，可不可以在编辑器框架层解决问题，尝试在编辑器的onBlur事件中保存以前的selection，然后在onFocus事件中恢复以前的selection，这样点击完工具条的操作按钮后，编辑器的selection能自动恢复。考虑到会有编辑器多实例的场景，最后只在onBlur的自动保存，没有在onFocus中自动恢复，否则跨editor操作时会出现蓝色选区不在光标点击位置的问题。
  - 在onBlur方法中保存selection对象到缓存后，可以接着对selection对象对应的节点添加mark，模拟选区的蓝色视觉效果，这样在编辑器失焦后可以自动在视觉上显示蓝色选区效果。此外，对缓存的selection对象也可以复用进行其他操作，比如从中获取具体文本作为评论引文。
- 实现评论功能也花费了较多的时间精力，难点在于整个应用和编辑器如何通信的机制不明确，评论高亮和侧边栏联动如何优化性能。
  - 由editor提供的插件机制可以在插件中直接拿到editor相关数据，但评论列表卡片默认显示在侧边栏，一般作为普通ui实现，而不作为编辑器插件实现。没有找到很好的解决办法，只是将editor对象保存全局react状态，然后在其他地方通过全局状态中的editor对象操作编辑器相关数据。
  - 添加评论后，编辑器中被评论文本会高亮，点击被评论文本时，能自动打开侧边栏且突出显示评论内容。这个点击事件可以添加在每个文本上，这样以React组件形式实现的每个文本都会注册onClick的事件监听器，这个监听器触发时会从当前节点查询所有评论id并找到长度最短的评论id进行高亮，然后在侧边栏突出显示对应的评论卡片。
  - 上面的实现方式能够work，但每个文本在渲染层都要添加事件监听器，考虑到React的合成事件SyntheticEvent会将几乎所有的事件代理(delegate)到document，当编辑器DOM节点非常多时，这里很可能导致性能问题。
  - 想要获取到点击位置文本的评论id，不一定要通过点击事件，对于编辑器，也可以通过选区的变化来获取选区内文本的内容和节点属性，而评论id就是自定义节点属性。这样在侧边栏组件中，通过全局状态里的editor对象可以注册selection change事件来计算长度最短的评论id，然后突出显示侧边栏中对应的评论卡片。这种实现方法移除了不必要注册的事件监听函数，提高了性能，但依赖React应用和editor的通信机制。
- 块编辑器可参考的实现太少，所以在实现具体功能时经常在slate的github仓库翻issues搜索其他开发者如何处理编辑器相关问题，效率比较低。
- 块编辑器的渲染层核心是对树形数据结构的递归渲染，理解以后感觉也没那么难了，但编辑器插件的边界如何划分、插件和核心如何通信、插件和插件如何通信，在业内很难找到比较成熟稳定的参考实现，所以在编辑器核心不稳定的情况下，开发的功能经常失效，在基础功能如选区、拖拽改动后迁移的成本也比较高。
# 产品方面
- 早期学术编辑器产品对标的是学术界常用的Overleaf，Overleaf编辑器也在github开源了。
  - 学术方面的编辑功能主要是数学公式、统计图表、参考文献、实时协作，这些在早期编辑器EA上基本都实现了，ui交互甚至比Overleaf更好，但功能的丰富程度和稳定性离Overleaf差得有点远。
  - 在维护早期编辑器EA阶段，待修复的bug列表非常长，所以在产品新功能上推进的不多，大部分时间花在提高已有功能的稳定性上。
- 块编辑器是当前业内追逐的热点，国内典型的是飞书文档、印象笔记Verse、wolai、FlowUs都上了块编辑器，国外的Notion、Anytype、Craft、WordPress也是在引领块编辑器的开发趋势。
  - 对于块编辑器，上述产品比较核心和共同的features包括块级节点拖拽、块级模版或小组件、双链展示相关文档或块级资源、database多维表格多种视图、块级协作编辑。
  - 上述每个功能点都需要花费大量的时间精力来研发，比较遗憾的是，我的开发工作主要偏向前端交互实现和普通业务crud，对于核心功能只做过早期demo，没有投入更多时间深入实现。
# 离职感悟
- 在创业公司工作的这段经历，我最大的感受是不确定和意外的事情挺多的。
  - 一开始加入公司，看到前一批的程序员都跑光了，我以为公司就要倒闭了，当时对公司不确定甚至偏悲观的未来挺担心的。
  - 在业务项目交付和意外的大佬同事加入后，公司的产品和开发就逐渐进入了比较正常的节奏。
  - 随着新加入的同事变多，慢慢地花在开会和沟通上的时间越来越多，甚至我开始觉得写代码是一件不那么重要的事情了。由于产品架构还不稳定，并且编辑器功能也不丰富，其中很多需求讨论和进度对齐确实是必要的，但花费的时间还是多了一点。
  - 因为公司快速发展等方面的原因，在一个接一个的功能特性设计、开发、实现交付后，我感到压力很大，并且业务开发的工作是没有尽头的，于是就有了这次离职。我更希望有一个比较稳定的基础架构，在开发完一个feature后有时间对代码进行优化、对比下其他项目、或是一个阶段性的小总结，但现在的创业公司暂时不能提供这种条件。
- 这算是我第一次正式的工作经历，有收获，也有遗憾。
  - 在技术上的收获挺多的，对日常ui交互开发和普通业务crud更熟练了，熟练到让我觉得这样的工作并不能给我带来技术上的积累和提升，所以以后我会把更多的时间和精力放在编辑器或表格这类架构更优秀、复杂度更高的项目上。
  - 对编辑器架构的理解深入了一点，自研编辑器的过程早晚也会模仿开源的编辑器的架构，实现自己的schema、state、command、transform。因为主流开源编辑器都是这么做的，数据与视图分离、模块单一职责、支持协作的数据结构、冲突处理，这些思想在开源编辑器里面用得多是因为真的很通用，自研编辑器一开始也许不会把这些概念和设计全用上，但随着业务的复杂度变高早晚会一个一个加上类似的设计。
  - 最大的遗憾是我一开始就准备做的多维表格因为各种原因而没有深入参与，类似的开发我以后会在个人玩具项目里面做一做。
  - 与编辑器紧密相关的功能我开发的不多，这里面也有很多遗憾，主要原因还是开发实力不足导致开发思路不够清晰、开发进度比较慢。以后有时间我不会花大量的时间自研编辑器，我会以一个成熟的开源编辑器作为基础，去分析和改进它的实现。
- 离职后我花了很多时间思考了两个困扰我很久的问题。
- 当我接到一个开发任务，初步分析后其中可能有很难需要我花很多时间和精力去解决的问题，我该如何处理？ 
  - 完全不接任务和硬着头皮接下任务却延期都是不好的，这方面我以前确实没做好，以前接到任务大多是做ui交互和业务开发没太大问题，但碰到编辑器方面思路不清晰的或找不到参考的，以前我就经常死磕，去翻源码、文档、issues，虽然大多数都解决了，但开发时间花费过多。
  - 对于这个问题，我想到的更好的处理方式应该是主动去找其他开发同事交流问题和思路，负责相关模块的同事或经验丰富的同事很可能也考虑过类似问题的处理方式。其次也可以找产品沟通下，分析下设计意图和可能的折中处理。
  - 在具体开发写代码时，碰到很难处理的问题，也应该及时和leader沟通，引入更多人力支持或修改功能排期，及时沟通进度和风险很重要。
- 找工作时，是选择自己很喜欢的那一类工作，还是普通前端开发工作？
  - 以前我会毫不犹豫地选最喜欢的工作，这次编辑器相关工作就是我很喜欢的那种，但很多时候理想很美好、现实却可能不会朝自己预期的那样发展。
  - 现在我会更看重团队的研发实力和技术积累，当团队研发实力足够强时，基础架构的稳定性才有保证，这样业务层的开发才会顺利，否则架构层一改动，其他要跟着改的地方太多了。当团队技术实力很强时，要改变开拓新产品也会变得容易，通常发展前景也会很好。
# 下一步
- 好风频借力，送我上青云...
